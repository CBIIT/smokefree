!function(e,n,t,r,o,a){var i,s,c,l=this,u=Math.floor(1e4*Math.random()),d=Function.prototype,f=/^((http.?:)\/\/([^:\/\s]+)(:\d+)*)/,p=/[\-\w]+\/\.\.\//,h=/([^:])\/\//g,g="",m={},v=e.easyXDM,y="easyXDM_",w=!1,b=d;function k(e,n){var t=typeof e[n];return"function"==t||!("object"!=t||!e[n])||"unknown"==t}function _(e,n){return!("object"!=typeof e[n]||!e[n])}function x(){var e="application/x-shockwave-flash";if(!B(navigator.plugins)&&"object"==typeof navigator.plugins["Shockwave Flash"]){var n=navigator.plugins["Shockwave Flash"].description;n&&!B(navigator.mimeTypes)&&navigator.mimeTypes[e]&&navigator.mimeTypes[e].enabledPlugin&&(s=n.match(/\d+/g))}if(!s){var t;try{t=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),s=Array.prototype.slice.call(t.GetVariable("$version").match(/(\d+),(\d+),(\d+),(\d+)/),1),t=null}catch(e){}}if(!s)return!1;var r=parseInt(s[0],10),o=parseInt(s[1],10);return c=r>9&&o>0,!0}var T,M;if(k(e,"addEventListener"))T=function(e,n,t){b("adding listener "+n),e.addEventListener(n,t,!1)},M=function(e,n,t){b("removing listener "+n),e.removeEventListener(n,t,!1)};else{if(!k(e,"attachEvent"))throw new Error("Browser not supported");T=function(e,n,t){b("adding listener "+n),e.attachEvent("on"+n,t)},M=function(e,n,t){b("removing listener "+n),e.detachEvent("on"+n,t)}}var O,E=!1,S=[];"readyState"in n?(O=n.readyState,E="complete"==O||~navigator.userAgent.indexOf("AppleWebKit/")&&("loaded"==O||"interactive"==O)):E=!!n.body;function D(){if(!E){E=!0,b("firing dom_onReady");for(var e=0;e<S.length;e++)S[e]();S.length=0}}if(!E){if(k(e,"addEventListener"))T(n,"DOMContentLoaded",D);else if(T(n,"readystatechange",function(){"complete"==n.readyState&&D()}),n.documentElement.doScroll&&e===top){var R=function(){if(!E){try{n.documentElement.doScroll("left")}catch(e){return void r(R,1)}D()}};R()}T(e,"load",D)}function F(e,n){E?e.call(n):S.push(function(){e.call(n)})}function N(e){if(!e)throw new Error("url is undefined or empty");return e.match(f)[3]}function P(e){if(!e)throw new Error("url is undefined or empty");if(/^file/.test(e))throw new Error("The file:// protocol is not supported");var n=e.toLowerCase().match(f),t=n[2],r=n[3],o=n[4]||"";return("http:"==t&&":80"==o||"https:"==t&&":443"==o)&&(o=""),t+"//"+r+o}function H(e){if(!e)throw new Error("url is undefined or empty");if(!(e=e.replace(h,"$1/")).match(/^(http||https):\/\//)){var n="/"===e.substring(0,1)?"":t.pathname;"/"!==n.substring(n.length-1)&&(n=n.substring(0,n.lastIndexOf("/")+1)),e=t.protocol+"//"+t.host+n+e}for(;p.test(e);)e=e.replace(p,"");return b("resolved url '"+e+"'"),e}function C(e,n){if(!n)throw new Error("parameters is undefined or null");var t="",r=e.indexOf("#");-1!==r&&(t=e.substring(r),e=e.substring(0,r));var o=[];for(var i in n)n.hasOwnProperty(i)&&o.push(i+"="+a(n[i]));return e+(w?"#":-1==e.indexOf("?")?"?":"&")+o.join("&")+t}var X=function(e){for(var n,t={},r=(e=e.substring(1).split("&")).length;r--;)t[(n=e[r].split("="))[0]]=o(n[1]);return t}(/xdm_e=/.test(t.search)?t.search:t.hash);function B(e){return void 0===e}var j=function(){var e={},n={a:[1,2,3]},t='{"a":[1,2,3]}';return"undefined"!=typeof JSON&&"function"==typeof JSON.stringify&&JSON.stringify(n).replace(/\s/g,"")===t?JSON:(Object.toJSON&&Object.toJSON(n).replace(/\s/g,"")===t&&(e.stringify=Object.toJSON),"function"==typeof String.prototype.evalJSON&&(n=t.evalJSON()).a&&3===n.a.length&&3===n.a[2]&&(e.parse=function(e){return e.evalJSON()}),e.stringify&&e.parse?(j=function(){return e},e):null)};function L(e,n,t){var r;for(var o in n)n.hasOwnProperty(o)&&(o in e?"object"==typeof(r=n[o])?L(e[o],r,t):t||(e[o]=n[o]):e[o]=n[o]);return e}function A(e){b("creating frame: "+e.props.src),B(i)&&function(){var e=n.body.appendChild(n.createElement("form")),t=e.appendChild(n.createElement("input"));t.name=y+"TEST"+u,i=t!==e.elements[t.name],n.body.removeChild(e),b("HAS_NAME_PROPERTY_BUG: "+i)}();var t;i?t=n.createElement('<iframe name="'+e.props.name+'"/>'):(t=n.createElement("IFRAME")).name=e.props.name,t.id=t.name=e.props.name,delete e.props.name,"string"==typeof e.container&&(e.container=n.getElementById(e.container)),e.container||(L(t.style,{position:"absolute",top:"-2000px",left:"0px"}),e.container=n.body);var r=e.props.src;if(e.props.src="javascript:false",L(t,e.props),t.border=t.frameBorder=0,t.allowTransparency=!0,e.container.appendChild(t),e.onLoad&&T(t,"load",e.onLoad),e.usePost){var o,a=e.container.appendChild(n.createElement("form"));if(a.target=t.name,a.action=r,a.method="POST","object"==typeof e.usePost)for(var s in e.usePost)e.usePost.hasOwnProperty(s)&&(i?o=n.createElement('<input name="'+s+'"/>'):(o=n.createElement("INPUT")).name=s,o.value=e.usePost[s],a.appendChild(o));a.submit(),a.parentNode.removeChild(a)}else t.src=r;return e.props.src=r,t}function J(e,n){"string"==typeof e&&(e=[e]);for(var t,r=e.length;r--;)if(t=e[r],(t=new RegExp("^"==t.substr(0,1)?t:"^"+t.replace(/(\*)/g,".$1").replace(/\?/g,".")+"$")).test(n))return!0;return!1}function q(r){var o,a=r.protocol;if(r.isHost=r.isHost||B(X.xdm_p),w=r.hash||!1,b("preparing transport stack"),r.props||(r.props={}),r.isHost)r.remote=H(r.remote),r.channel=r.channel||"default"+u++,r.secret=Math.random().toString(16).substring(2),B(a)?(a=P(t.href)==P(r.remote)?"4":k(e,"postMessage")||k(n,"postMessage")?"1":r.swf&&k(e,"ActiveXObject")&&x()?"6":"Gecko"===navigator.product&&"frameElement"in e&&-1==navigator.userAgent.indexOf("WebKit")?"5":r.remoteHelper?"2":"0",b("selecting protocol: "+a)):b("using protocol: "+a);else if(b("using parameters from query"),r.channel=X.xdm_c.replace(/["'<>\\]/g,""),r.secret=X.xdm_s,r.remote=X.xdm_e.replace(/["'<>\\]/g,""),a=X.xdm_p,r.acl&&!J(r.acl,r.remote))throw new Error("Access denied for "+r.remote);switch(r.protocol=a,a){case"0":if(L(r,{interval:100,delay:2e3,useResize:!0,useParent:!1,usePolling:!1},!0),r.isHost){if(!r.local){b("looking for image to use as local");for(var i,c=t.protocol+"//"+t.host,l=n.body.getElementsByTagName("img"),d=l.length;d--;)if((i=l[d]).src.substring(0,c.length)===c){r.local=i.src;break}r.local||(b("no image found, defaulting to using the window"),r.local=e)}var f={xdm_c:r.channel,xdm_p:0};r.local===e?(r.usePolling=!0,r.useParent=!0,r.local=t.protocol+"//"+t.host+t.pathname+t.search,f.xdm_e=r.local,f.xdm_pa=1):f.xdm_e=H(r.local),r.container&&(r.useResize=!1,f.xdm_po=1),r.remote=C(r.remote,f)}else L(r,{channel:X.xdm_c,remote:X.xdm_e,useParent:!B(X.xdm_pa),usePolling:!B(X.xdm_po),useResize:!r.useParent&&r.useResize});o=[new m.stack.HashTransport(r),new m.stack.ReliableBehavior({}),new m.stack.QueueBehavior({encode:!0,maxLength:4e3-r.remote.length}),new m.stack.VerifyBehavior({initiate:r.isHost})];break;case"1":o=[new m.stack.PostMessageTransport(r)];break;case"2":r.remoteHelper=H(r.remoteHelper),o=[new m.stack.NameTransport(r),new m.stack.QueueBehavior,new m.stack.VerifyBehavior({initiate:r.isHost})];break;case"3":o=[new m.stack.NixTransport(r)];break;case"4":o=[new m.stack.SameOriginTransport(r)];break;case"5":o=[new m.stack.FrameElementTransport(r)];break;case"6":s||x(),o=[new m.stack.FlashTransport(r)]}return o.push(new m.stack.QueueBehavior({lazy:r.lazy,remove:!0})),o}function I(e){for(var n,t={incoming:function(e,n){this.up.incoming(e,n)},outgoing:function(e,n){this.down.outgoing(e,n)},callback:function(e){this.up.callback(e)},init:function(){this.down.init()},destroy:function(){this.down.destroy()}},r=0,o=e.length;r<o;r++)L(n=e[r],t,!0),0!==r&&(n.down=e[r-1]),r!==o-1&&(n.up=e[r+1]);return n}L(m,{version:"2.4.17.1",query:X,stack:{},apply:L,getJSONObject:j,whenReady:F,noConflict:function(n){if("string"!=typeof n||!n)throw new Error("namespace must be a non-empty string");return b("Settings namespace to '"+n+"'"),e.easyXDM=v,(g=n)&&(y="easyXDM_"+g.replace(".","_")+"_"),m}}),L(m,{checkAcl:J,getDomainName:N,getLocation:P,appendQueryParameters:C});var W={_deferred:[],flush:function(){this.trace("... deferred messages ...");for(var e=0,n=this._deferred.length;e<n;e++)this.trace(this._deferred[e]);this._deferred.length=0,this.trace("... end of deferred messages ...")},getTime:function(){var e=new Date,n=e.getHours()+"",t=e.getMinutes()+"",r=e.getSeconds()+"",o=e.getMilliseconds()+"";return 1==n.length&&(n="0"+n),1==t.length&&(t="0"+t),1==r.length&&(r="0"+r),n+":"+t+":"+r+"."+(o="000".substring(o.length)+o)},log:function(n){!_(e,"console")||B(console.log)?this.log=d:this.log=function(e){console.log(t.host+(g?":"+g:"")+" - "+this.getTime()+": "+e)},this.log(n)},trace:function(r){if(E){var o=n.getElementById("log");o?this.trace=function(e){try{o.appendChild(n.createElement("div")).appendChild(n.createTextNode(t.host+(g?":"+g:"")+" - "+this.getTime()+":"+e)),o.scrollTop=o.scrollHeight}catch(e){}}:_(e,"console")&&!B(console.info)&&(this.trace=function(e){console.info(t.host+(g?":"+g:"")+" - "+this.getTime()+":"+e)})}else 0===this._deferred.length&&m.whenReady(W.flush,W),this._deferred.push(r),this.log(r)},getTracer:function(e){return function(n){W.trace(e+": "+n)}}};W.log("easyXDM present on '"+t.href),m.Debug=W,b=W.getTracer("{Private}"),m.DomHelper={on:T,un:M,requiresJSON:function(t){_(e,"JSON")?W.log("native JSON found"):(W.log("loading external JSON"),n.write('<script type="text/javascript" src="'+t+'"><\/script>'))}},function(){var e={};m.Fn={set:function(n,t){this._trace("storing function "+n),e[n]=t},get:function(n,t){this._trace("retrieving function "+n);var r=e[n];return r||this._trace(n+" not found"),t&&delete e[n],r}},m.Fn._trace=W.getTracer("easyXDM.Fn")}(),m.Socket=function(e){W.getTracer("easyXDM.Socket")("constructor");var n=I(q(e).concat([{incoming:function(n,t){e.onMessage(n,t)},callback:function(n){e.onReady&&e.onReady(n)}}])),t=P(e.remote);this.origin=P(e.remote),this.destroy=function(){n.destroy()},this.postMessage=function(e){n.outgoing(e,t)},n.init()},m.Rpc=function(e,n){if(W.getTracer("easyXDM.Rpc")("constructor"),n.local)for(var t in n.local)if(n.local.hasOwnProperty(t)){var r=n.local[t];"function"==typeof r&&(n.local[t]={method:r})}var o=I(q(e).concat([new m.stack.RpcBehavior(this,n),{callback:function(n){e.onReady&&e.onReady(n)}}]));this.origin=P(e.remote),this.destroy=function(){o.destroy()},o.init()},m.stack.SameOriginTransport=function(e){var n=W.getTracer("easyXDM.stack.SameOriginTransport");n("constructor");var o,a,i,s;return{outgoing:function(e,n,t){i(e),t&&t()},destroy:function(){n("destroy"),a&&(a.parentNode.removeChild(a),a=null)},onDOMReady:function(){n("init"),s=P(e.remote),e.isHost?(L(e.props,{src:C(e.remote,{xdm_e:t.protocol+"//"+t.host+t.pathname,xdm_c:e.channel,xdm_p:4}),name:y+e.channel+"_provider"}),a=A(e),m.Fn.set(e.channel,function(e){return i=e,r(function(){o.up.callback(!0)},0),function(e){o.up.incoming(e,s)}})):(i=function(){var e=parent;if(""!==g)for(var n=0,t=g.split(".");n<t.length;n++){if(!e)throw new Error(t.slice(0,n+1).join(".")+" is not an object");e=e[t[n]]}if(!e||!e.easyXDM)throw new Error("Could not find easyXDM in parent."+g);return e.easyXDM}().Fn.get(e.channel,!0)(function(e){o.up.incoming(e,s)}),r(function(){o.up.callback(!0)},0))},init:function(){F(o.onDOMReady,o)}}},m.stack.FlashTransport=function(e){var o=W.getTracer("easyXDM.stack.FlashTransport");if(o("constructor"),!e.swf)throw new Error("Path to easyxdm.swf is missing");var a,i,s,u,d;function p(e,n){r(function(){o("received message"),a.up.incoming(e,s)},0)}function h(t){o("creating factory with SWF from "+t);var r=e.swf+"?host="+e.isHost,a="easyXDM_swf_"+Math.floor(1e4*Math.random());m.Fn.set("flash_loaded"+t.replace(/[\-.]/g,"_"),function(){m.stack.FlashTransport[t].swf=u=d.firstChild;for(var e=m.stack.FlashTransport[t].queue,n=0;n<e.length;n++)e[n]();e.length=0}),e.swfContainer?d="string"==typeof e.swfContainer?n.getElementById(e.swfContainer):e.swfContainer:(L((d=n.createElement("div")).style,c&&e.swfNoThrottle?{height:"20px",width:"20px",position:"fixed",right:0,top:0}:{height:"1px",width:"1px",position:"absolute",overflow:"hidden",right:0,top:0}),n.body.appendChild(d));var i="callback=flash_loaded"+t.replace(/[\-.]/g,"_")+"&proto="+l.location.protocol+"&domain="+N(l.location.href)+"&port="+function(e){if(!e)throw new Error("url is undefined or empty");return e.match(f)[4]||""}(l.location.href)+"&ns="+g;i+="&log=true",d.innerHTML="<object height='20' width='20' type='application/x-shockwave-flash' id='"+a+"' data='"+r+"'><param name='allowScriptAccess' value='always'></param><param name='wmode' value='transparent'><param name='movie' value='"+r+"'></param><param name='flashvars' value='"+i+"'></param><embed type='application/x-shockwave-flash' FlashVars='"+i+"' allowScriptAccess='always' wmode='transparent' src='"+r+"' height='1' width='1'></embed></object>"}return{outgoing:function(n,t,r){u.postMessage(e.channel,n.toString()),r&&r()},destroy:function(){o("destroy");try{u.destroyChannel(e.channel)}catch(e){}u=null,i&&(i.parentNode.removeChild(i),i=null)},onDOMReady:function(){o("init"),s=e.remote,m.Fn.set("flash_"+e.channel+"_init",function(){r(function(){o("firing onReady"),a.up.callback(!0)})}),m.Fn.set("flash_"+e.channel+"_onMessage",p),e.swf=H(e.swf);var n=N(e.swf),l=function(){m.stack.FlashTransport[n].init=!0,(u=m.stack.FlashTransport[n].swf).createChannel(e.channel,e.secret,P(e.remote),e.isHost),e.isHost&&(c&&e.swfNoThrottle&&L(e.props,{position:"fixed",right:0,top:0,height:"20px",width:"20px"}),L(e.props,{src:C(e.remote,{xdm_e:P(t.href),xdm_c:e.channel,xdm_p:6,xdm_s:e.secret}),name:y+e.channel+"_provider"}),i=A(e))};m.stack.FlashTransport[n]&&m.stack.FlashTransport[n].init?l():m.stack.FlashTransport[n]?m.stack.FlashTransport[n].queue.push(l):(m.stack.FlashTransport[n]={queue:[l]},h(n))},init:function(){F(a.onDOMReady,a)}}},m.stack.PostMessageTransport=function(n){var o=W.getTracer("easyXDM.stack.PostMessageTransport");o("constructor");var a,i,s,c;function l(e){var r=function(e){if(e.origin)return P(e.origin);if(e.uri)return P(e.uri);if(e.domain)return t.protocol+"//"+e.domain;throw"Unable to retrieve the origin of the event"}(e);o("received message '"+e.data+"' from "+r),r==c&&e.data.substring(0,n.channel.length+1)==n.channel+" "&&a.up.incoming(e.data.substring(n.channel.length+1),r)}return{outgoing:function(e,t,r){s.postMessage(n.channel+" "+e,t||c),r&&r()},destroy:function(){o("destroy"),M(e,"message",l),i&&(s=null,i.parentNode.removeChild(i),i=null)},onDOMReady:function(){if(o("init"),c=P(n.remote),n.isHost){var u=function(t){t.data==n.channel+"-ready"&&(o("firing onReady"),s="postMessage"in i.contentWindow?i.contentWindow:i.contentWindow.document,M(e,"message",u),T(e,"message",l),r(function(){a.up.callback(!0)},0))};T(e,"message",u),L(n.props,{src:C(n.remote,{xdm_e:P(t.href),xdm_c:n.channel,xdm_p:1}),name:y+n.channel+"_provider"}),i=A(n)}else T(e,"message",l),(s="postMessage"in e.parent?e.parent:e.parent.document).postMessage(n.channel+"-ready",c),r(function(){a.up.callback(!0)},0)},init:function(){F(a.onDOMReady,a)}}},m.stack.FrameElementTransport=function(o){var a=W.getTracer("easyXDM.stack.FrameElementTransport");a("constructor");var i,s,c,l;return{outgoing:function(e,n,t){c.call(this,e),t&&t()},destroy:function(){a("destroy"),s&&(s.parentNode.removeChild(s),s=null)},onDOMReady:function(){a("init"),l=P(o.remote),o.isHost?(L(o.props,{src:C(o.remote,{xdm_e:P(t.href),xdm_c:o.channel,xdm_p:5}),name:y+o.channel+"_provider"}),(s=A(o)).fn=function(e){return delete s.fn,c=e,r(function(){i.up.callback(!0)},0),function(e){i.up.incoming(e,l)}}):(n.referrer&&P(n.referrer)!=X.xdm_e&&(e.top.location=X.xdm_e),c=e.frameElement.fn(function(e){i.up.incoming(e,l)}),i.up.callback(!0))},init:function(){F(i.onDOMReady,i)}}},m.stack.NameTransport=function(e){var n=W.getTracer("easyXDM.stack.NameTransport");if(n("constructor"),e.isHost&&B(e.remoteHelper))throw n("missing remoteHelper"),new Error("missing remoteHelper");var t,o,a,i,s,c,l,u;function d(t){var r=e.remoteHelper+(o?"#_3":"#_2")+e.channel;n("sending message "+t),n("navigating to  '"+r+"'"),a.contentWindow.sendMessage(t,r)}function f(){o?2!=++s&&o||t.up.callback(!0):(d("ready"),n("calling onReady"),t.up.callback(!0))}function p(e){n("received message "+e),t.up.incoming(e,l)}function h(){c&&r(function(){c(!0)},0)}return{outgoing:function(e,n,t){c=t,d(e)},destroy:function(){n("destroy"),a.parentNode.removeChild(a),a=null,o&&(i.parentNode.removeChild(i),i=null)},onDOMReady:function(){n("init"),o=e.isHost,s=0,l=P(e.remote),e.local=H(e.local),o?(m.Fn.set(e.channel,function(t){n("received initial message "+t),o&&"ready"===t&&(m.Fn.set(e.channel,p),f())}),u=C(e.remote,{xdm_e:e.local,xdm_c:e.channel,xdm_p:2}),L(e.props,{src:u+"#"+e.channel,name:y+e.channel+"_provider"}),i=A(e)):(e.remoteHelper=e.remote,m.Fn.set(e.channel,p));var t=function(){var n=a||this;M(n,"load",t),m.Fn.set(e.channel+"_load",h),function e(){"function"==typeof n.contentWindow.sendMessage?f():r(e,50)}()};a=A({props:{src:e.local+"#_4"+e.channel},onLoad:t})},init:function(){F(t.onDOMReady,t)}}},m.stack.HashTransport=function(n){var t=W.getTracer("easyXDM.stack.HashTransport");t("constructor");var o,a,i,s,c,l,u,d,f,p;function h(){if(u){var e=u.location.href,n="",r=e.indexOf("#");-1!=r&&(n=e.substring(r)),n&&n!=c&&(t("poll: new message"),t("received message '"+(c=n)+"' from "+p),o.up.incoming(c.substring(c.indexOf("_")+1),p))}}function g(){t("starting polling"),i=setInterval(h,s)}return{outgoing:function(e,r){!function(e){if(t("sending message '"+(l+1)+" "+e+"' to "+p),d){var r=n.remote+"#"+l+++"_"+e;(a||!f?d.contentWindow:d).location=r}else t("no caller window")}(e)},destroy:function(){e.clearInterval(i),!a&&f||d.parentNode.removeChild(d),d=null},onDOMReady:function(){if(a=n.isHost,s=n.interval,c="#"+n.channel,l=0,f=n.useParent,p=P(n.remote),a){if(L(n.props,{src:n.remote,name:y+n.channel+"_provider"}),f)n.onLoad=function(){u=e,g(),o.up.callback(!0)};else{var i=0,h=n.delay/50;!function e(){if(++i>h)throw t("unable to get reference to _listenerWindow, giving up"),new Error("Unable to reference listenerwindow");try{u=d.contentWindow.frames[y+n.channel+"_consumer"]}catch(e){}u?(g(),t("got a reference to _listenerWindow"),o.up.callback(!0)):r(e,50)}()}d=A(n)}else u=e,g(),f?(d=parent,o.up.callback(!0)):(L(n,{props:{src:n.remote+"#"+n.channel+new Date,name:y+n.channel+"_consumer"},onLoad:function(){o.up.callback(!0)}}),d=A(n))},init:function(){F(o.onDOMReady,o)}}},m.stack.ReliableBehavior=function(e){var n=W.getTracer("easyXDM.stack.ReliableBehavior");n("constructor");var t,r,o=0,a=0,i="";return{incoming:function(e,s){n("incoming: "+e);var c=e.indexOf("_"),l=e.substring(0,c).split(",");e=e.substring(c+1),l[0]==o&&(n("message delivered"),i="",r&&(r(!0),r=null)),e.length>0&&(n("sending ack, and passing on "+e),t.down.outgoing(l[1]+","+o+"_"+i,s),a!=l[1]&&(a=l[1],t.up.incoming(e,s)))},outgoing:function(e,n,s){i=e,r=s,t.down.outgoing(a+","+ ++o+"_"+e,n)}}},m.stack.QueueBehavior=function(e){var n=W.getTracer("easyXDM.stack.QueueBehavior");n("constructor");var t,i,s=[],c=!0,l="",u=0,d=!1,f=!1;function p(){if(e.remove&&0===s.length)return n("removing myself from the stack"),(o=t).up.down=o.down,o.down.up=o.up,void(o.up=o.down=null);var o;if(!c&&0!==s.length&&!i){n("dispatching from queue"),c=!0;var a=s.shift();t.down.outgoing(a.data,a.origin,function(e){c=!1,a.callback&&r(function(){a.callback(e)},0),p()})}}return{init:function(){B(e)&&(e={}),e.maxLength&&(u=e.maxLength,f=!0),e.lazy?d=!0:t.down.init()},callback:function(e){c=!1;var n=t.up;p(),n.callback(e)},incoming:function(r,a){if(f){var i=r.indexOf("_"),s=parseInt(r.substring(0,i),10);l+=r.substring(i+1),0===s?(n("received the last fragment"),e.encode&&(l=o(l)),t.up.incoming(l,a),l=""):n("waiting for more fragments, seq="+r)}else t.up.incoming(r,a)},outgoing:function(r,o,i){e.encode&&(r=a(r));var c,l=[];if(f){for(;0!==r.length;)c=r.substring(0,u),r=r.substring(c.length),l.push(c);for(;c=l.shift();)n("enqueuing"),s.push({data:l.length+"_"+c,origin:o,callback:0===l.length?i:null})}else s.push({data:r,origin:o,callback:i});d?t.down.init():p()},destroy:function(){n("destroy"),i=!0,t.down.destroy()}}},m.stack.VerifyBehavior=function(e){var n=W.getTracer("easyXDM.stack.VerifyBehavior");if(n("constructor"),B(e.initiate))throw new Error("settings.initiate is not set");var t,r,o;function a(){n("requesting verification"),r=Math.random().toString(16).substring(2),t.down.outgoing(r)}return{incoming:function(i,s){var c=i.indexOf("_");-1===c?i===r?(n("verified, calling callback"),t.up.callback(!0)):o||(n("returning secret"),o=i,e.initiate||a(),t.down.outgoing(i)):i.substring(0,c)===o&&t.up.incoming(i.substring(c+1),s)},outgoing:function(e,n,o){t.down.outgoing(r+"_"+e,n,o)},callback:function(n){e.initiate&&a()}}},m.stack.RpcBehavior=function(e,n){var t,r=W.getTracer("easyXDM.stack.RpcBehavior"),o=n.serializer||j(),a=0,i={};function s(e){e.jsonrpc="2.0",t.down.outgoing(o.stringify(e))}function c(e,n){var t=Array.prototype.slice;return r("creating method "+n),function(){r("executing method "+n);var o,c=arguments.length,l={method:n};c>0&&"function"==typeof arguments[c-1]?(c>1&&"function"==typeof arguments[c-2]?(o={success:arguments[c-2],error:arguments[c-1]},l.params=t.call(arguments,0,c-2)):(o={success:arguments[c-1]},l.params=t.call(arguments,0,c-1)),i[""+ ++a]=o,l.id=a):l.params=t.call(arguments,0),e.namedParams&&1===l.params.length&&(l.params=l.params[0]),s(l)}}function l(e,n,t,o){if(!t)return r("requested to execute non-existent procedure "+e),void(n&&s({id:n,error:{code:-32601,message:"Procedure not found."}}));r("requested to execute procedure "+e);var a,i;n?(a=function(e){a=d,s({id:n,result:e})},i=function(e,t){i=d;var r={id:n,error:{code:-32099,message:e}};t&&(r.error.data=t),s(r)}):a=i=d,c=o,"[object Array]"!==Object.prototype.toString.call(c)&&(o=[o]);var c;try{var l=t.method.apply(t.scope,o.concat([a,i]));B(l)||a(l)}catch(e){i(e.message)}}return{incoming:function(e,t){var a=o.parse(e);if(a.method)r("received request to execute method "+a.method+(a.id?" using callback id "+a.id:"")),n.handle?n.handle(a,s):l(a.method,a.id,n.local[a.method],a.params);else{r("received return value destined to callback with id "+a.id);var c=i[a.id];a.error?c.error?c.error(a.error):r("unhandled error returned."):c.success&&c.success(a.result),delete i[a.id]}},init:function(){if(r("init"),n.remote){r("creating stubs");for(var o in n.remote)n.remote.hasOwnProperty(o)&&(e[o]=c(n.remote[o],o))}t.down.init()},destroy:function(){r("destroy");for(var o in n.remote)n.remote.hasOwnProperty(o)&&e.hasOwnProperty(o)&&delete e[o];t.down.destroy()}}},l.easyXDM=m}(window,document,location,window.setTimeout,decodeURIComponent,encodeURIComponent);