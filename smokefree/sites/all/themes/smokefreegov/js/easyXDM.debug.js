!function(g,d,f,m,p,h){var c,l,v,u,y,w=this,b=Math.floor(1e4*Math.random()),k=Function.prototype,_=/^((http.?:)\/\/([^:\/\s]+)(:\d+)*)/,t=/[\-\w]+\/\.\.\//,r=/([^:])\/\//g,x="",T={},n=g.easyXDM,M="easyXDM_",O=!1,E=k;function D(e,n){var t=typeof e[n];return"function"==t||!("object"!=t||!e[n])||"unknown"==t}function o(e,n){return!("object"!=typeof e[n]||!e[n])}function S(){var e,n="Shockwave Flash",t="application/x-shockwave-flash";if(!B(navigator.plugins)&&"object"==typeof navigator.plugins[n]){var r=navigator.plugins[n].description;r&&!B(navigator.mimeTypes)&&navigator.mimeTypes[t]&&navigator.mimeTypes[t].enabledPlugin&&(l=r.match(/\d+/g))}if(!l)try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),l=Array.prototype.slice.call(e.GetVariable("$version").match(/(\d+),(\d+),(\d+),(\d+)/),1),e=null}catch(e){}if(!l)return!1;var o=parseInt(l[0],10),a=parseInt(l[1],10);return v=9<o&&0<a,!0}if(D(g,"addEventListener"))u=function(e,n,t){E("adding listener "+n),e.addEventListener(n,t,!1)},y=function(e,n,t){E("removing listener "+n),e.removeEventListener(n,t,!1)};else{if(!D(g,"attachEvent"))throw new Error("Browser not supported");u=function(e,n,t){E("adding listener "+n),e.attachEvent("on"+n,t)},y=function(e,n,t){E("removing listener "+n),e.detachEvent("on"+n,t)}}var e,a=!1,i=[];function s(){if(!a){a=!0,E("firing dom_onReady");for(var e=0;e<i.length;e++)i[e]();i.length=0}}if("readyState"in d?(e=d.readyState,a="complete"==e||~navigator.userAgent.indexOf("AppleWebKit/")&&("loaded"==e||"interactive"==e)):a=!!d.body,!a){if(D(g,"addEventListener"))u(d,"DOMContentLoaded",s);else if(u(d,"readystatechange",function(){"complete"==d.readyState&&s()}),d.documentElement.doScroll&&g===top){var R=function(){if(!a){try{d.documentElement.doScroll("left")}catch(e){return void m(R,1)}s()}};R()}u(g,"load",s)}function F(e,n){a?e.call(n):i.push(function(){e.call(n)})}function N(e){if(!e)throw new Error("url is undefined or empty");return e.match(_)[3]}function P(e){if(!e)throw new Error("url is undefined or empty");if(/^file/.test(e))throw new Error("The file:// protocol is not supported");var n=e.toLowerCase().match(_),t=n[2],r=n[3],o=n[4]||"";return("http:"==t&&":80"==o||"https:"==t&&":443"==o)&&(o=""),t+"//"+r+o}function H(e){if(!e)throw new Error("url is undefined or empty");if(!(e=e.replace(r,"$1/")).match(/^(http||https):\/\//)){var n="/"===e.substring(0,1)?"":f.pathname;"/"!==n.substring(n.length-1)&&(n=n.substring(0,n.lastIndexOf("/")+1)),e=f.protocol+"//"+f.host+n+e}for(;t.test(e);)e=e.replace(t,"");return E("resolved url '"+e+"'"),e}function C(e,n){if(!n)throw new Error("parameters is undefined or null");var t="",r=e.indexOf("#");-1!==r&&(t=e.substring(r),e=e.substring(0,r));var o=[];for(var a in n)n.hasOwnProperty(a)&&o.push(a+"="+h(n[a]));return e+(O?"#":-1==e.indexOf("?")?"?":"&")+o.join("&")+t}var X=function(e){for(var n,t={},r=(e=e.substring(1).split("&")).length;r--;)t[(n=e[r].split("="))[0]]=p(n[1]);return t}(/xdm_e=/.test(f.search)?f.search:f.hash);function B(e){return void 0===e}var j=function(){var e={},n={a:[1,2,3]},t='{"a":[1,2,3]}';return"undefined"!=typeof JSON&&"function"==typeof JSON.stringify&&JSON.stringify(n).replace(/\s/g,"")===t?JSON:(Object.toJSON&&Object.toJSON(n).replace(/\s/g,"")===t&&(e.stringify=Object.toJSON),"function"==typeof String.prototype.evalJSON&&(n=t.evalJSON()).a&&3===n.a.length&&3===n.a[2]&&(e.parse=function(e){return e.evalJSON()}),e.stringify&&e.parse?(j=function(){return e},e):null)};function L(e,n,t){var r;for(var o in n)n.hasOwnProperty(o)&&(o in e?"object"==typeof(r=n[o])?L(e[o],r,t):t||(e[o]=n[o]):e[o]=n[o]);return e}function A(e){var n,t,r;E("creating frame: "+e.props.src),B(c)&&(n=d.body.appendChild(d.createElement("form")),(t=n.appendChild(d.createElement("input"))).name=M+"TEST"+b,c=t!==n.elements[t.name],d.body.removeChild(n),E("HAS_NAME_PROPERTY_BUG: "+c)),c?r=d.createElement('<iframe name="'+e.props.name+'"/>'):(r=d.createElement("IFRAME")).name=e.props.name,r.id=r.name=e.props.name,delete e.props.name,"string"==typeof e.container&&(e.container=d.getElementById(e.container)),e.container||(L(r.style,{position:"absolute",top:"-2000px",left:"0px"}),e.container=d.body);var o=e.props.src;if(e.props.src="javascript:false",L(r,e.props),r.border=r.frameBorder=0,r.allowTransparency=!0,e.container.appendChild(r),e.onLoad&&u(r,"load",e.onLoad),e.usePost){var a,i=e.container.appendChild(d.createElement("form"));if(i.target=r.name,i.action=o,i.method="POST","object"==typeof e.usePost)for(var s in e.usePost)e.usePost.hasOwnProperty(s)&&(c?a=d.createElement('<input name="'+s+'"/>'):(a=d.createElement("INPUT")).name=s,a.value=e.usePost[s],i.appendChild(a));i.submit(),i.parentNode.removeChild(i)}else r.src=o;return e.props.src=o,r}function J(e,n){"string"==typeof e&&(e=[e]);for(var t,r=e.length;r--;)if(t=e[r],(t=new RegExp("^"==t.substr(0,1)?t:"^"+t.replace(/(\*)/g,".$1").replace(/\?/g,".")+"$")).test(n))return!0;return!1}function q(e){var n,t=e.protocol;if(e.isHost=e.isHost||B(X.xdm_p),O=e.hash||!1,E("preparing transport stack"),e.props||(e.props={}),e.isHost)e.remote=H(e.remote),e.channel=e.channel||"default"+b++,e.secret=Math.random().toString(16).substring(2),B(t)?(t=P(f.href)==P(e.remote)?"4":D(g,"postMessage")||D(d,"postMessage")?"1":e.swf&&D(g,"ActiveXObject")&&S()?"6":"Gecko"===navigator.product&&"frameElement"in g&&-1==navigator.userAgent.indexOf("WebKit")?"5":e.remoteHelper?"2":"0",E("selecting protocol: "+t)):E("using protocol: "+t);else if(E("using parameters from query"),e.channel=X.xdm_c.replace(/["'<>\\]/g,""),e.secret=X.xdm_s,e.remote=X.xdm_e.replace(/["'<>\\]/g,""),t=X.xdm_p,e.acl&&!J(e.acl,e.remote))throw new Error("Access denied for "+e.remote);switch(e.protocol=t){case"0":if(L(e,{interval:100,delay:2e3,useResize:!0,useParent:!1,usePolling:!1},!0),e.isHost){if(!e.local){E("looking for image to use as local");for(var r,o=f.protocol+"//"+f.host,a=d.body.getElementsByTagName("img"),i=a.length;i--;)if((r=a[i]).src.substring(0,o.length)===o){e.local=r.src;break}e.local||(E("no image found, defaulting to using the window"),e.local=g)}var s={xdm_c:e.channel,xdm_p:0};e.local===g?(e.usePolling=!0,e.useParent=!0,e.local=f.protocol+"//"+f.host+f.pathname+f.search,s.xdm_e=e.local,s.xdm_pa=1):s.xdm_e=H(e.local),e.container&&(e.useResize=!1,s.xdm_po=1),e.remote=C(e.remote,s)}else L(e,{channel:X.xdm_c,remote:X.xdm_e,useParent:!B(X.xdm_pa),usePolling:!B(X.xdm_po),useResize:!e.useParent&&e.useResize});n=[new T.stack.HashTransport(e),new T.stack.ReliableBehavior({}),new T.stack.QueueBehavior({encode:!0,maxLength:4e3-e.remote.length}),new T.stack.VerifyBehavior({initiate:e.isHost})];break;case"1":n=[new T.stack.PostMessageTransport(e)];break;case"2":e.remoteHelper=H(e.remoteHelper),n=[new T.stack.NameTransport(e),new T.stack.QueueBehavior,new T.stack.VerifyBehavior({initiate:e.isHost})];break;case"3":n=[new T.stack.NixTransport(e)];break;case"4":n=[new T.stack.SameOriginTransport(e)];break;case"5":n=[new T.stack.FrameElementTransport(e)];break;case"6":l||S(),n=[new T.stack.FlashTransport(e)]}return n.push(new T.stack.QueueBehavior({lazy:e.lazy,remove:!0})),n}function I(e){for(var n,t={incoming:function(e,n){this.up.incoming(e,n)},outgoing:function(e,n){this.down.outgoing(e,n)},callback:function(e){this.up.callback(e)},init:function(){this.down.init()},destroy:function(){this.down.destroy()}},r=0,o=e.length;r<o;r++)L(n=e[r],t,!0),0!==r&&(n.down=e[r-1]),r!==o-1&&(n.up=e[r+1]);return n}L(T,{version:"2.4.17.1",query:X,stack:{},apply:L,getJSONObject:j,whenReady:F,noConflict:function(e){if("string"!=typeof e||!e)throw new Error("namespace must be a non-empty string");return E("Settings namespace to '"+e+"'"),g.easyXDM=n,(x=e)&&(M="easyXDM_"+x.replace(".","_")+"_"),T}}),L(T,{checkAcl:J,getDomainName:N,getLocation:P,appendQueryParameters:C});var W,z={_deferred:[],flush:function(){this.trace("... deferred messages ...");for(var e=0,n=this._deferred.length;e<n;e++)this.trace(this._deferred[e]);this._deferred.length=0,this.trace("... end of deferred messages ...")},getTime:function(){var e=new Date,n=e.getHours()+"",t=e.getMinutes()+"",r=e.getSeconds()+"",o=e.getMilliseconds()+"";return 1==n.length&&(n="0"+n),1==t.length&&(t="0"+t),1==r.length&&(r="0"+r),n+":"+t+":"+r+"."+(o="000".substring(o.length)+o)},log:function(e){!o(g,"console")||B(console.log)?this.log=k:this.log=function(e){console.log(f.host+(x?":"+x:"")+" - "+this.getTime()+": "+e)},this.log(e)},trace:function(e){if(a){var n=d.getElementById("log");n?this.trace=function(e){try{n.appendChild(d.createElement("div")).appendChild(d.createTextNode(f.host+(x?":"+x:"")+" - "+this.getTime()+":"+e)),n.scrollTop=n.scrollHeight}catch(e){}}:o(g,"console")&&!B(console.info)&&(this.trace=function(e){console.info(f.host+(x?":"+x:"")+" - "+this.getTime()+":"+e)})}else 0===this._deferred.length&&T.whenReady(z.flush,z),this._deferred.push(e),this.log(e)},getTracer:function(n){return function(e){z.trace(n+": "+e)}}};z.log("easyXDM present on '"+f.href),T.Debug=z,E=z.getTracer("{Private}"),T.DomHelper={on:u,un:y,requiresJSON:function(e){o(g,"JSON")?z.log("native JSON found"):(z.log("loading external JSON"),d.write('<script type="text/javascript" src="'+e+'"><\/script>'))}},W={},T.Fn={set:function(e,n){this._trace("storing function "+e),W[e]=n},get:function(e,n){this._trace("retrieving function "+e);var t=W[e];return t||this._trace(e+" not found"),n&&delete W[e],t}},T.Fn._trace=z.getTracer("easyXDM.Fn"),T.Socket=function(t){z.getTracer("easyXDM.Socket")("constructor");var n=I(q(t).concat([{incoming:function(e,n){t.onMessage(e,n)},callback:function(e){t.onReady&&t.onReady(e)}}])),r=P(t.remote);this.origin=P(t.remote),this.destroy=function(){n.destroy()},this.postMessage=function(e){n.outgoing(e,r)},n.init()},T.Rpc=function(n,e){if(z.getTracer("easyXDM.Rpc")("constructor"),e.local)for(var t in e.local)if(e.local.hasOwnProperty(t)){var r=e.local[t];"function"==typeof r&&(e.local[t]={method:r})}var o=I(q(n).concat([new T.stack.RpcBehavior(this,e),{callback:function(e){n.onReady&&n.onReady(e)}}]));this.origin=P(n.remote),this.destroy=function(){o.destroy()},o.init()},T.stack.SameOriginTransport=function(e){var n,t,r,o,a=z.getTracer("easyXDM.stack.SameOriginTransport");return a("constructor"),n={outgoing:function(e,n,t){r(e),t&&t()},destroy:function(){a("destroy"),t&&(t.parentNode.removeChild(t),t=null)},onDOMReady:function(){a("init"),o=P(e.remote),e.isHost?(L(e.props,{src:C(e.remote,{xdm_e:f.protocol+"//"+f.host+f.pathname,xdm_c:e.channel,xdm_p:4}),name:M+e.channel+"_provider"}),t=A(e),T.Fn.set(e.channel,function(e){return r=e,m(function(){n.up.callback(!0)},0),function(e){n.up.incoming(e,o)}})):(r=function(){var e=parent;if(""!==x)for(var n=0,t=x.split(".");n<t.length;n++){if(!e)throw new Error(t.slice(0,n+1).join(".")+" is not an object");e=e[t[n]]}if(!e||!e.easyXDM)throw new Error("Could not find easyXDM in parent."+x);return e.easyXDM}().Fn.get(e.channel,!0)(function(e){n.up.incoming(e,o)}),m(function(){n.up.callback(!0)},0))},init:function(){F(n.onDOMReady,n)}}},T.stack.FlashTransport=function(o){var t,r,a,i,s,c=z.getTracer("easyXDM.stack.FlashTransport");if(c("constructor"),!o.swf)throw new Error("Path to easyxdm.swf is missing");function l(e,n){m(function(){c("received message"),t.up.incoming(e,a)},0)}function u(t){c("creating factory with SWF from "+t);var e=o.swf+"?host="+o.isHost,n="easyXDM_swf_"+Math.floor(1e4*Math.random());T.Fn.set("flash_loaded"+t.replace(/[\-.]/g,"_"),function(){T.stack.FlashTransport[t].swf=i=s.firstChild;for(var e=T.stack.FlashTransport[t].queue,n=0;n<e.length;n++)e[n]();e.length=0}),o.swfContainer?s="string"==typeof o.swfContainer?d.getElementById(o.swfContainer):o.swfContainer:(L((s=d.createElement("div")).style,v&&o.swfNoThrottle?{height:"20px",width:"20px",position:"fixed",right:0,top:0}:{height:"1px",width:"1px",position:"absolute",overflow:"hidden",right:0,top:0}),d.body.appendChild(s));var r="callback=flash_loaded"+t.replace(/[\-.]/g,"_")+"&proto="+w.location.protocol+"&domain="+N(w.location.href)+"&port="+function(e){if(!e)throw new Error("url is undefined or empty");return e.match(_)[4]||""}(w.location.href)+"&ns="+x;r+="&log=true",s.innerHTML="<object height='20' width='20' type='application/x-shockwave-flash' id='"+n+"' data='"+e+"'><param name='allowScriptAccess' value='always'></param><param name='wmode' value='transparent'><param name='movie' value='"+e+"'></param><param name='flashvars' value='"+r+"'></param><embed type='application/x-shockwave-flash' FlashVars='"+r+"' allowScriptAccess='always' wmode='transparent' src='"+e+"' height='1' width='1'></embed></object>"}return t={outgoing:function(e,n,t){i.postMessage(o.channel,e.toString()),t&&t()},destroy:function(){c("destroy");try{i.destroyChannel(o.channel)}catch(e){}i=null,r&&(r.parentNode.removeChild(r),r=null)},onDOMReady:function(){c("init"),a=o.remote,T.Fn.set("flash_"+o.channel+"_init",function(){m(function(){c("firing onReady"),t.up.callback(!0)})}),T.Fn.set("flash_"+o.channel+"_onMessage",l),o.swf=H(o.swf);var e=N(o.swf),n=function(){T.stack.FlashTransport[e].init=!0,(i=T.stack.FlashTransport[e].swf).createChannel(o.channel,o.secret,P(o.remote),o.isHost),o.isHost&&(v&&o.swfNoThrottle&&L(o.props,{position:"fixed",right:0,top:0,height:"20px",width:"20px"}),L(o.props,{src:C(o.remote,{xdm_e:P(f.href),xdm_c:o.channel,xdm_p:6,xdm_s:o.secret}),name:M+o.channel+"_provider"}),r=A(o))};T.stack.FlashTransport[e]&&T.stack.FlashTransport[e].init?n():T.stack.FlashTransport[e]?T.stack.FlashTransport[e].queue.push(n):(T.stack.FlashTransport[e]={queue:[n]},u(e))},init:function(){F(t.onDOMReady,t)}}},T.stack.PostMessageTransport=function(r){var t,o,a,i,s=z.getTracer("easyXDM.stack.PostMessageTransport");function c(e){var n=function(e){if(e.origin)return P(e.origin);if(e.uri)return P(e.uri);if(e.domain)return f.protocol+"//"+e.domain;throw"Unable to retrieve the origin of the event"}(e);s("received message '"+e.data+"' from "+n),n==i&&e.data.substring(0,r.channel.length+1)==r.channel+" "&&t.up.incoming(e.data.substring(r.channel.length+1),n)}return s("constructor"),t={outgoing:function(e,n,t){a.postMessage(r.channel+" "+e,n||i),t&&t()},destroy:function(){s("destroy"),y(g,"message",c),o&&(a=null,o.parentNode.removeChild(o),o=null)},onDOMReady:function(){if(s("init"),i=P(r.remote),r.isHost){var n=function(e){e.data==r.channel+"-ready"&&(s("firing onReady"),a="postMessage"in o.contentWindow?o.contentWindow:o.contentWindow.document,y(g,"message",n),u(g,"message",c),m(function(){t.up.callback(!0)},0))};u(g,"message",n),L(r.props,{src:C(r.remote,{xdm_e:P(f.href),xdm_c:r.channel,xdm_p:1}),name:M+r.channel+"_provider"}),o=A(r)}else u(g,"message",c),(a="postMessage"in g.parent?g.parent:g.parent.document).postMessage(r.channel+"-ready",i),m(function(){t.up.callback(!0)},0)},init:function(){F(t.onDOMReady,t)}}},T.stack.FrameElementTransport=function(e){var n,t,r,o,a=z.getTracer("easyXDM.stack.FrameElementTransport");return a("constructor"),n={outgoing:function(e,n,t){r.call(this,e),t&&t()},destroy:function(){a("destroy"),t&&(t.parentNode.removeChild(t),t=null)},onDOMReady:function(){a("init"),o=P(e.remote),e.isHost?(L(e.props,{src:C(e.remote,{xdm_e:P(f.href),xdm_c:e.channel,xdm_p:5}),name:M+e.channel+"_provider"}),(t=A(e)).fn=function(e){return delete t.fn,r=e,m(function(){n.up.callback(!0)},0),function(e){n.up.incoming(e,o)}}):(d.referrer&&P(d.referrer)!=X.xdm_e&&(g.top.location=X.xdm_e),r=g.frameElement.fn(function(e){n.up.incoming(e,o)}),n.up.callback(!0))},init:function(){F(n.onDOMReady,n)}}},T.stack.NameTransport=function(t){var n,r,o,a,i,s,c,l,u=z.getTracer("easyXDM.stack.NameTransport");if(u("constructor"),t.isHost&&B(t.remoteHelper))throw u("missing remoteHelper"),new Error("missing remoteHelper");function d(e){var n=t.remoteHelper+(r?"#_3":"#_2")+t.channel;u("sending message "+e),u("navigating to  '"+n+"'"),o.contentWindow.sendMessage(e,n)}function f(){r?2!=++i&&r||n.up.callback(!0):(d("ready"),u("calling onReady"),n.up.callback(!0))}function p(e){u("received message "+e),n.up.incoming(e,c)}function h(){s&&m(function(){s(!0)},0)}return n={outgoing:function(e,n,t){s=t,d(e)},destroy:function(){u("destroy"),o.parentNode.removeChild(o),o=null,r&&(a.parentNode.removeChild(a),a=null)},onDOMReady:function(){u("init"),r=t.isHost,i=0,c=P(t.remote),t.local=H(t.local),r?(T.Fn.set(t.channel,function(e){u("received initial message "+e),r&&"ready"===e&&(T.Fn.set(t.channel,p),f())}),l=C(t.remote,{xdm_e:t.local,xdm_c:t.channel,xdm_p:2}),L(t.props,{src:l+"#"+t.channel,name:M+t.channel+"_provider"}),a=A(t)):(t.remoteHelper=t.remote,T.Fn.set(t.channel,p));var e=function(){var n=o||this;y(n,"load",e),T.Fn.set(t.channel+"_load",h),function e(){"function"==typeof n.contentWindow.sendMessage?f():m(e,50)}()};o=A({props:{src:t.local+"#_4"+t.channel},onLoad:e})},init:function(){F(n.onDOMReady,n)}}},T.stack.HashTransport=function(r){var o,a=z.getTracer("easyXDM.stack.HashTransport");a("constructor");var i,e,s,c,l,u,d,f,p;function n(){if(u){var e=u.location.href,n="",t=e.indexOf("#");-1!=t&&(n=e.substring(t)),n&&n!=c&&(a("poll: new message"),a("received message '"+(c=n)+"' from "+p),o.up.incoming(c.substring(c.indexOf("_")+1),p))}}function h(){a("starting polling"),e=setInterval(n,s)}return o={outgoing:function(e,n){!function(e){if(a("sending message '"+(l+1)+" "+e+"' to "+p),d){var n=r.remote+"#"+l+++"_"+e;(i||!f?d.contentWindow:d).location=n}else a("no caller window")}(e)},destroy:function(){g.clearInterval(e),!i&&f||d.parentNode.removeChild(d),d=null},onDOMReady:function(){if(i=r.isHost,s=r.interval,c="#"+r.channel,l=0,f=r.useParent,p=P(r.remote),i){if(L(r.props,{src:r.remote,name:M+r.channel+"_provider"}),f)r.onLoad=function(){u=g,h(),o.up.callback(!0)};else{var n=0,t=r.delay/50;!function e(){if(++n>t)throw a("unable to get reference to _listenerWindow, giving up"),new Error("Unable to reference listenerwindow");try{u=d.contentWindow.frames[M+r.channel+"_consumer"]}catch(e){}u?(h(),a("got a reference to _listenerWindow"),o.up.callback(!0)):m(e,50)}()}d=A(r)}else u=g,h(),f?(d=parent,o.up.callback(!0)):(L(r,{props:{src:r.remote+"#"+r.channel+new Date,name:M+r.channel+"_consumer"},onLoad:function(){o.up.callback(!0)}}),d=A(r))},init:function(){F(o.onDOMReady,o)}}},T.stack.ReliableBehavior=function(e){var o,a,i=z.getTracer("easyXDM.stack.ReliableBehavior");i("constructor");var s=0,c=0,l="";return o={incoming:function(e,n){i("incoming: "+e);var t=e.indexOf("_"),r=e.substring(0,t).split(",");e=e.substring(t+1),r[0]==s&&(i("message delivered"),l="",a&&(a(!0),a=null)),0<e.length&&(i("sending ack, and passing on "+e),o.down.outgoing(r[1]+","+s+"_"+l,n),c!=r[1]&&(c=r[1],o.up.incoming(e,n)))},outgoing:function(e,n,t){l=e,a=t,o.down.outgoing(c+","+ ++s+"_"+e,n)}}},T.stack.QueueBehavior=function(a){var i=z.getTracer("easyXDM.stack.QueueBehavior");i("constructor");var s,t,c=[],r=!0,o="",l=0,u=!1,d=!1;function f(){if(a.remove&&0===c.length)return i("removing myself from the stack"),(e=s).up.down=e.down,e.down.up=e.up,void(e.up=e.down=null);var e;if(!r&&0!==c.length&&!t){i("dispatching from queue"),r=!0;var n=c.shift();s.down.outgoing(n.data,n.origin,function(e){r=!1,n.callback&&m(function(){n.callback(e)},0),f()})}}return s={init:function(){B(a)&&(a={}),a.maxLength&&(l=a.maxLength,d=!0),a.lazy?u=!0:s.down.init()},callback:function(e){r=!1;var n=s.up;f(),n.callback(e)},incoming:function(e,n){if(d){var t=e.indexOf("_"),r=parseInt(e.substring(0,t),10);o+=e.substring(t+1),0===r?(i("received the last fragment"),a.encode&&(o=p(o)),s.up.incoming(o,n),o=""):i("waiting for more fragments, seq="+e)}else s.up.incoming(e,n)},outgoing:function(e,n,t){a.encode&&(e=h(e));var r,o=[];if(d){for(;0!==e.length;)r=e.substring(0,l),e=e.substring(r.length),o.push(r);for(;r=o.shift();)i("enqueuing"),c.push({data:o.length+"_"+r,origin:n,callback:0===o.length?t:null})}else c.push({data:e,origin:n,callback:t});u?s.down.init():f()},destroy:function(){i("destroy"),t=!0,s.down.destroy()}}},T.stack.VerifyBehavior=function(r){var o=z.getTracer("easyXDM.stack.VerifyBehavior");if(o("constructor"),B(r.initiate))throw new Error("settings.initiate is not set");var a,i,s;function c(){o("requesting verification"),i=Math.random().toString(16).substring(2),a.down.outgoing(i)}return a={incoming:function(e,n){var t=e.indexOf("_");-1===t?e===i?(o("verified, calling callback"),a.up.callback(!0)):s||(o("returning secret"),s=e,r.initiate||c(),a.down.outgoing(e)):e.substring(0,t)===s&&a.up.incoming(e.substring(t+1),n)},outgoing:function(e,n,t){a.down.outgoing(i+"_"+e,n,t)},callback:function(e){r.initiate&&c()}}},T.stack.RpcBehavior=function(n,o){var t,c=z.getTracer("easyXDM.stack.RpcBehavior"),a=o.serializer||j(),i=0,s={};function l(e){e.jsonrpc="2.0",t.down.outgoing(a.stringify(e))}function r(r,o){var a=Array.prototype.slice;return c("creating method "+o),function(){c("executing method "+o);var e,n=arguments.length,t={method:o};0<n&&"function"==typeof arguments[n-1]?(1<n&&"function"==typeof arguments[n-2]?(e={success:arguments[n-2],error:arguments[n-1]},t.params=a.call(arguments,0,n-2)):(e={success:arguments[n-1]},t.params=a.call(arguments,0,n-1)),s[""+ ++i]=e,t.id=i):t.params=a.call(arguments,0),r.namedParams&&1===t.params.length&&(t.params=t.params[0]),l(t)}}function u(e,r,n,t){if(!n)return c("requested to execute non-existent procedure "+e),void(r&&l({id:r,error:{code:-32601,message:"Procedure not found."}}));var o,a,i;c("requested to execute procedure "+e),r?(o=function(e){o=k,l({id:r,result:e})},a=function(e,n){a=k;var t={id:r,error:{code:-32099,message:e}};n&&(t.error.data=n),l(t)}):o=a=k,i=t,"[object Array]"!==Object.prototype.toString.call(i)&&(t=[t]);try{var s=n.method.apply(n.scope,t.concat([o,a]));B(s)||o(s)}catch(e){a(e.message)}}return t={incoming:function(e,n){var t=a.parse(e);if(t.method)c("received request to execute method "+t.method+(t.id?" using callback id "+t.id:"")),o.handle?o.handle(t,l):u(t.method,t.id,o.local[t.method],t.params);else{c("received return value destined to callback with id "+t.id);var r=s[t.id];t.error?r.error?r.error(t.error):c("unhandled error returned."):r.success&&r.success(t.result),delete s[t.id]}},init:function(){if(c("init"),o.remote)for(var e in c("creating stubs"),o.remote)o.remote.hasOwnProperty(e)&&(n[e]=r(o.remote[e],e));t.down.init()},destroy:function(){for(var e in c("destroy"),o.remote)o.remote.hasOwnProperty(e)&&n.hasOwnProperty(e)&&delete n[e];t.down.destroy()}}},w.easyXDM=T}(window,document,location,window.setTimeout,decodeURIComponent,encodeURIComponent);